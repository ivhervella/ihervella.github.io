<!DOCTYPE html>
<html>

<head>
    <title>Mapa interactivo de los alojamientos de Airbnb en Madrid</title>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }

        .control-wrapper {
            padding: 10px;
            margin-left: 10px
        }

        .price-input-container {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 10px;
            margin-left: 10px;
        }

        .price-input {
            width: auto;
            min-width: 100px;
            padding: 5px;
            margin: 0 10px;
            text-align: center;
        }

        #districtFilter {
            background-color: #fff;
            border: 2px solid #fff;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .3);
            margin-top: 10px;
            margin-left: 10px;
            margin-bottom: 22px;
            font-size: 15px;
            height: auto;
            overflow-y: auto;
        }

        #districtFilter option {
            margin: 4px;
            padding: 2px 5px;
        }

        #neighbourhoodFilter {
            background-color: #fff;
            border: 2px solid #fff;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .3);
            margin-top: 10px;
            margin-left: 10px;
            margin-bottom: 22px;
            font-size: 15px;
            height: auto;
            overflow-y: auto;
        }

        #neighbourhoodFilter option {
            margin: 4px;
            padding: 2px 5px;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        async function cargarDatos() {
            const response = await fetch('https://raw.githubusercontent.com/ivhervella/ihervella.github.io/main/alojamientos_mapa.csv');
            const data = await response.text();
            return data;
        }

        let markers = [];
        let minPriceInput, maxPriceInput;

        function actualizarFiltroPrecio() {
            filtrarPuntosMapa();
        }
        parsearCSV

        function parsearPrecio(priceString) {
            if (priceString && priceString.trim() !== '') {
                return parseFloat(priceString.replace(/[$,]/g, ''));
            }

            return NaN;
        }

        function traducirTexto(texto) {

            const traducciones = {
                'bedroom': 'dormitorio',
                'bedrooms': 'dormitorios',
                'in': 'en',
                'home': 'Casa',
                'rental unit': 'Casa de alquiler',
                'bath': 'baño',
                'baths': 'baños',
                'bed': 'cama',
                'beds': 'camas',
                'private bath': 'baño privado',
                'private baths': 'baños privados',
                'shared bath': 'baño compartido',
                'shared baths': 'baños compartidos'
            };

            const pattern = new RegExp(Object.keys(traducciones).join('|'), 'gi');

            const textoTraducido = texto.replace(pattern, match => traducciones[match.toLowerCase()]);

            return textoTraducido;
        }

        function obtenerNumero(str) {
            if (str && str.trim() !== '') {
                return str.split('.')[0];
            }
            return NaN;
        }

        function comprobarValoracion(str) {
            if (str && str.trim() !== '') {
                return str;
            }
            return "No especificado";
        }
        function parsearCSV(data) {
            const alojamientos = [];
            const lines = data.split('\n');
            lines.forEach((line, index) => {
                if (index > 0) {
                    const columnas = line.split(',');
                    const alojamiento_name = traducirTexto(columnas[0]);
                    const neighborhood = columnas[3];
                    const neighborhood_group = columnas[4];
                    const latitude = parseFloat(columnas[5]);
                    const longitude = parseFloat(columnas[6]);
                    const roomType = columnas[7];
                    const capacity = obtenerNumero(columnas[9]);
                    const price = parsearPrecio(columnas[10]);
                    const review_score = comprobarValoracion(columnas[11]);

                    if (!isNaN(latitude) && !isNaN(longitude) && !isNaN(price)) {
                        alojamientos.push({ lat: latitude, lng: longitude, roomType, price, alojamiento_name, capacity, review_score, neighborhood, neighborhood_group });
                    }
                }
            });
            return alojamientos;
        }


        function crearControlFiltroPrecio(map) {
            const controlWrapper = document.createElement('div');
            controlWrapper.style.backgroundColor = '#fff';
            controlWrapper.style.marginTop = '10px';
            controlWrapper.style.marginLeft = '10px';
            controlWrapper.style.marginBottom = '22px';
            controlWrapper.style.textAlign = 'center';
            controlWrapper.style.border = '2px solid #fff';
            controlWrapper.style.borderRadius = '3px';
            controlWrapper.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';

            const priceInputContainer = document.createElement('div');
            priceInputContainer.classList.add('price-input-container');

            minPriceInput = document.createElement('input');
            minPriceInput.type = 'number';
            minPriceInput.placeholder = 'Precio mínimo';
            minPriceInput.classList.add('price-input');
            minPriceInput.id = 'minPriceInput';
            minPriceInput.onchange = actualizarFiltroPrecio;

            maxPriceInput = document.createElement('input');
            maxPriceInput.type = 'number';
            maxPriceInput.placeholder = 'Precio máximo';
            maxPriceInput.classList.add('price-input');
            maxPriceInput.id = 'maxPriceInput';
            maxPriceInput.onchange = actualizarFiltroPrecio;

            priceInputContainer.appendChild(minPriceInput);
            priceInputContainer.appendChild(maxPriceInput);
            const spaceElement = document.createElement('div');
            spaceElement.style.margin = '0 4px';
            controlWrapper.appendChild(spaceElement);
            controlWrapper.appendChild(priceInputContainer);

            map.controls[google.maps.ControlPosition.TOP_LEFT].push(controlWrapper);
        }


        function crearControlFiltroTipoAlojamiento(map) {

            const controlWrapper = document.createElement('div');
            controlWrapper.style.backgroundColor = '#fff';
            controlWrapper.style.marginTop = '10px';
            controlWrapper.style.marginBottom = '22px';
            controlWrapper.style.textAlign = 'center';
            controlWrapper.style.border = '2px solid #fff';
            controlWrapper.style.borderRadius = '3px';
            controlWrapper.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';

            const filterSelect = document.createElement('select');
            filterSelect.id = 'roomTypeFilter';
            filterSelect.innerHTML = `
                <option value="all">Todos los tipos de alojamiento</option>
                <option value="Habitación privada">Habitación privada</option>
                <option value="Casa entera">Casa entera</option>
                <option value="Habitación compartida">Habitación compartida</option>
				<option value="Habitación de hotel">Habitación de hotel</option>
                <!-- Add other room types as needed -->
            `;
            filterSelect.onchange = filtrarPuntosMapa;
            filterSelect.style.border = 'none';
            filterSelect.style.outline = 'none';
            filterSelect.style.boxShadow = 'none';
            filterSelect.style.height = '40px';
            filterSelect.style.fontSize = '15px';
            filterSelect.style.margin = '5px 0';

            controlWrapper.appendChild(filterSelect);
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(controlWrapper);
        }

        function rellenarFiltroDistritos(alojamientos, map) {
            const districtFilter = document.createElement('select');
            districtFilter.id = 'districtFilter';
            districtFilter.multiple = true;
            districtFilter.size = 5;
            districtFilter.style.width = '200px';
            districtFilter.onchange = filtrarPuntosMapa;

            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los distritos';
            districtFilter.appendChild(allOption);

            const districtSet = new Set();
            alojamientos.forEach(alojamiento => {
                districtSet.add(alojamiento.neighborhood_group);
            });

            const sortedDistricts = Array.from(districtSet).sort();

            sortedDistricts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtFilter.appendChild(option);
            });

            const districtFilterControl = document.createElement('div');
            districtFilterControl.classList.add('custom-map-control');
            districtFilterControl.appendChild(districtFilter);

            map.controls[google.maps.ControlPosition.TOP_LEFT].push(districtFilterControl);
        }

        function rellenarFiltroBarrios(alojamientos, map) {
            const neighbourhoodFilter = document.createElement('select');
            neighbourhoodFilter.id = 'neighbourhoodFilter';
            neighbourhoodFilter.multiple = true;
            neighbourhoodFilter.size = 5;
            neighbourhoodFilter.style.width = '200px';
            neighbourhoodFilter.onchange = filtrarPuntosMapa;

            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los barrios';
            neighbourhoodFilter.appendChild(allOption);

            const neighbourhoodSet = new Set();
            alojamientos.forEach(alojamiento => {
                neighbourhoodSet.add(alojamiento.neighborhood);
            });

            const sortedNeighbourhoods = Array.from(neighbourhoodSet).sort();

            sortedNeighbourhoods.forEach(neighbourhood => {
                const option = document.createElement('option');
                option.value = neighbourhood;
                option.textContent = neighbourhood;
                neighbourhoodFilter.appendChild(option);
            });

            const neighbourhoodFilterControl = document.createElement('div');
            neighbourhoodFilterControl.classList.add('custom-map-control');
            neighbourhoodFilterControl.appendChild(neighbourhoodFilter);

            map.controls[google.maps.ControlPosition.TOP_LEFT].push(neighbourhoodFilterControl);
        }

        function filtrarPuntosMapa() {
            const selectedRoomType = document.getElementById('roomTypeFilter').value;
            const selectedDistricts = Array.from(document.getElementById('districtFilter').selectedOptions).map(option => option.value);
            const selectedNeighbourhoods = Array.from(document.getElementById('neighbourhoodFilter').selectedOptions).map(option => option.value);
            const minSelectedPrice = minPriceInput.value ? parseFloat(minPriceInput.value) : 0;
            const maxSelectedPrice = maxPriceInput.value ? parseFloat(maxPriceInput.value) : Infinity;

            markers.forEach(marker => {
                const isVisibleByType = selectedRoomType === 'all' || marker.roomType === selectedRoomType;
                const isVisibleByDistrict = selectedDistricts.includes('all') || selectedDistricts.length === 0 || selectedDistricts.includes(marker.neighborhood_group);
                const isVisibleByNeighbourhood = selectedNeighbourhoods.includes('all') || selectedNeighbourhoods.length === 0 || selectedNeighbourhoods.includes(marker.neighborhood);
                const isVisibleByPrice = marker.price >= minSelectedPrice && marker.price <= maxSelectedPrice;
                marker.setVisible(isVisibleByType && isVisibleByDistrict && isVisibleByNeighbourhood && isVisibleByPrice);
            });
        }

        function initMap() {
            const options = {
                zoom: 12,
                center: { lat: 40.416775, lng: -3.703790 }
            }

            const icono_mapa = {
                url: 'https://cdn-icons-png.flaticon.com/256/9202/9202669.png',
                scaledSize: new google.maps.Size(15, 15)
            };

            const map = new google.maps.Map(document.getElementById('map'), options);
            map.controls[google.maps.ControlPosition.TOP_LEFT].clear();
            crearControlFiltroTipoAlojamiento(map);
            crearControlFiltroPrecio(map);

            cargarDatos().then(csv => {
                const alojamientos = parsearCSV(csv);
                rellenarFiltroDistritos(alojamientos, map);
                rellenarFiltroBarrios(alojamientos, map);
                alojamientos.forEach(alojamiento => {

                    const contentString = `
                <div id="content">
                    <h1 id="firstHeading" class="firstHeading">${alojamiento.alojamiento_name}</h1>
                    <div id="bodyContent">
					<h3>Detalles del alojamiento</h3>
                        <p><b>Precio por día:</b> ${alojamiento.price}$</p>
						<p><b>Capacidad:</b> ${alojamiento.capacity} persona/s</p>
						<p><b>Valoración media:</b> ${alojamiento.review_score}★</p>
						<p><b>Barrio:</b> ${alojamiento.neighborhood}</p>
						<p><b>Distrito:</b> ${alojamiento.neighborhood_group}</p>
                        <img src="" alt="" style="width:100%;max-width:200px;">
                    </div>
                </div>`;

                    const infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    const marker = new google.maps.Marker({
                        position: alojamiento,
                        roomType: alojamiento.roomType,
                        price: alojamiento.price,
                        neighborhood: alojamiento.neighborhood,
                        neighborhood_group: alojamiento.neighborhood_group,
                        map: map,
                        icon: icono_mapa
                    });

                    marker.addListener('click', function () {
                        infowindow.open(map, marker);
                    });
                    markers.push(marker);

                });
            });
        }
    </script>
    <!-- Añadir la clave de API a la URL -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBKO7Mt6xZH73b7aUrOaE6KcwZCdwOirdg&callback=initMap">
        </script>
</body>

</html>
